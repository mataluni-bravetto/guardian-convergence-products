/**
 * Test Generator
 * Automated test generation from function signatures
 * 
 * Pattern: VALIDATION × TRUTH × CLARITY × ONE
 * Guardians: YAGNI × JØHN × AEYON
 * 
 * NO DEPENDENCIES - Pure Node.js
 */

const fs = require('fs');
const path = require('path');

function extractFunctions(content) {
  const functions = [];
  
  // Extract function declarations
  const funcDeclRegex = /function\s+(\w+)\s*\(([^)]*)\)/g;
  let match;
  while ((match = funcDeclRegex.exec(content)) !== null) {
    const funcName = match[1];
    const params = match[2].split(',').map(p => p.trim()).filter(p => p);
    functions.push({ name: funcName, params });
  }
  
  // Extract arrow functions
  const arrowFuncRegex = /const\s+(\w+)\s*=\s*\(([^)]*)\)\s*=>/g;
  while ((match = arrowFuncRegex.exec(content)) !== null) {
    const funcName = match[1];
    const params = match[2].split(',').map(p => p.trim()).filter(p => p);
    functions.push({ name: funcName, params });
  }
  
  return functions;
}

function generateTestCases(funcName, params) {
  const cases = [];
  
  // Basic test case
  cases.push(`test('${funcName} should handle basic input', () => {`);
  const args = params.map(() => 'testValue').join(', ');
  cases.push(`  const result = ${funcName}(${args})`);
  cases.push(`  expect(result).toBeDefined()`);
  cases.push(`})`);
  cases.push('');
  
  // Null/undefined test
  cases.push(`test('${funcName} should handle null/undefined', () => {`);
  const nullArgs = params.map(() => 'null').join(', ');
  cases.push(`  expect(() => ${funcName}(${nullArgs})).not.toThrow()`);
  cases.push(`})`);
  cases.push('');
  
  // Edge case test
  cases.push(`test('${funcName} should handle edge cases', () => {`);
  const edgeArgs = params.map(() => '0').join(', ');
  cases.push(`  const result = ${funcName}(${edgeArgs})`);
  cases.push(`  expect(result).toBeDefined()`);
  cases.push(`})`);
  
  return cases;
}

function generateTestFile(functions) {
  let output = `// Auto-generated test file\n`;
  output += `// Generated by AI Validation Toolkit\n\n`;
  output += `import { describe, test, expect } from '@jest/globals'\n\n`;
  
  functions.forEach(({ name, params }) => {
    output += `describe('${name}', () => {\n`;
    const testCases = generateTestCases(name, params);
    testCases.forEach(testCase => {
      output += `  ${testCase}\n`;
    });
    output += `})\n\n`;
  });
  
  return output;
}

function generateTests(filePath) {
  if (!fs.existsSync(filePath)) {
    throw new Error(`File not found: ${filePath}`);
  }
  
  const content = fs.readFileSync(filePath, 'utf-8');
  const functions = extractFunctions(content);
  
  if (functions.length === 0) {
    return null;
  }
  
  return generateTestFile(functions);
}

// CLI usage
if (require.main === module) {
  const filePath = process.argv[2];
  
  if (!filePath) {
    console.error('Usage: node test-generator.js <path-to-file>');
    console.error('Example: node test-generator.js src/utils.ts');
    process.exit(1);
  }
  
  if (!fs.existsSync(filePath)) {
    console.error(`Error: File not found: ${filePath}`);
    process.exit(1);
  }
  
  try {
    const testFile = generateTests(filePath);
    
    if (!testFile) {
      console.log('No functions found to generate tests for.');
      process.exit(0);
    }
    
    const outputPath = filePath.replace(/\.(ts|js|tsx|jsx)$/, '.test.$1');
    fs.writeFileSync(outputPath, testFile);
    console.log(`✓ Test file generated: ${outputPath}`);
  } catch (error) {
    console.error(`Error generating tests:`, error.message);
    process.exit(1);
  }
}

module.exports = { generateTests, extractFunctions };

